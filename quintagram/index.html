<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Cryptic Quintagram</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-body-tertiary">
    <div class="container col-10 col-md-6 col-lg-5">
        <div class="mt-5"></div>

        <div class="d-flex justify-content-center fs-3 mb-2"><strong>Cryptic Quintagram</strong></div>
        <div class="d-flex justify-content-center mb-3">ç»™å®šç­”æ¡ˆçš„æ‰€æœ‰å­—æ¯ï¼Œè§£å‡º5ä¸ªcryptic clueså§</div>
        <div class="d-flex justify-content-center align-items-center mb-3">
            <span class="me-5" id="timer">00:00</span>
            <button class="btn btn-dark" id="startToggleButton">å¼€å§‹</button>
            <button class="btn btn-dark" id="shareButton" style="display: none;" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="å¤±è¯¯æ•°ä»¥clueä¸ºå•ä½<br>ï¼ˆğŸŸ¢0ğŸŸ¡1ğŸŸ 2ğŸ”´3+ï¼‰">
                <i class="bi bi-upload me-1" data-bs-placement="left"></i>
                åˆ†äº«
            </button>
        </div>

        <div id="puzzle" style="display: none;">
            <div class="d-flex justify-content-center mb-3">
                <ul class="list-group border border-dark">
                    <li class="list-group-item">
                        <div class="mb-1" id="clue1"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue2"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue3"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue4"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue5"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                </ul>
            </div>

            <div id="additionalInfo">
                <div class="d-flex justify-content-center"><strong>å‰©ä½™å­—æ¯</strong></div>
                <div class="d-flex justify-content-center mb-3" id="remainingLetters"></div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-dark" id="submitButton">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="completeInfo" class="d-flex justify-content-center fs-5 fw-bold mb-2"></div>
        <div id="solution" class="d-flex justify-content-center"></div>

        <!-- <div class="mt-5 d-flex justify-content-center text-secondary">æœ‰ä»»ä½•é—®é¢˜ï¼Ÿè”ç³»ç®¡ç†å‘˜ï¼š1964825491ï¼ˆQQï¼‰</div> -->
        
        <div class="mb-5"></div>
    </div>

    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        const clueArray = Array('Idiotic plan to get rid of Republican (4)', 
                                'Son needs some trousers (6)',
                                'Reputation of old city featured in Express (7)', 
                                'A mistake making loaf of this kind? (7)',
                                'Date once ruined an amusing tale (8)');
        const answerArray = Array('DAFT', 'SLACKS', 'STATURE', 'BLOOMER', 'ANECDOTE');
        const solution = '1. def: idiotic; plan=draft; Republican=r; get rid ofè¡¨ç¤ºå»é™¤å­—æ¯(draft-r) <br>2. def: some trousers; son=s; need=lacks <br>3. def: reputation; old city=ur; express=state; featured inè¡¨ç¤ºåŒ…å« <br>4. double definition (mistake/loaf) <br>5. def: amusing tale; "date once" anagram (indicator: ruined) <br>'
        let lengthArray = Array(0, 0, 0, 0, 0);
        let allLetters = '';
        let lastInputArray = Array('', '', '', '', '');
        let remainingLetters = allLetters;
        let errorCountArray = Array(0, 0, 0, 0, 0);
        
        for (let i = 0; i < 5; i++) {
            let ans = answerArray[i];
            allLetters += ans;

            let clueDisplay = document.getElementById(`clue${i + 1}`);
            let clue = clueArray[i];
            clueDisplay.innerHTML = `<strong>${i + 1}</strong> ${clue}`;

            lengthArray[i] = ans.length;
        }
        allLetters = allLetters.split('').sort().join('');
        
        function GetCommonPrefix(str1, str2) {
            let prefix = "";
            const minLength = Math.min(str1.length, str2.length);

            for (let i = 0; i < minLength; i++) {
                if (str1[i] === str2[i]) {
                    prefix += str1[i];
                } else {
                    break;
                }
            }

            return prefix;
        }

        // é™åˆ¶è¾“å…¥å­—æ¯é›†ï¼Œå¹¶è½¬ä¸ºå¤§å†™ï¼Œé™åˆ¶é•¿åº¦
        let inputs = document.querySelectorAll('.ans-input');
        inputs.forEach((input, index) => {
            // æŒ‰ä¸‹å›è½¦æ—¶è·³è½¬åˆ°ä¸‹ä¸€ä¸ªinput
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (index + 1 < inputs.length) {
                        inputs[index + 1].focus();
                    }
                }
            });

            input.setAttribute('maxlength', lengthArray[index]);
            input.addEventListener('input', () => {
                // è¾“å…¥åå»é™¤ç­”æ¡ˆéªŒè¯
                input.classList.remove('is-valid');
                input.classList.remove('is-invalid');

                let lastInput = lastInputArray[index];
                let curInput = input.value;
                let commonPrefix = GetCommonPrefix(lastInput, curInput);
                let filteredValue = commonPrefix;
                for (let i = commonPrefix.length; i < curInput.length; i++) {
                    let inputtedChar = curInput[i];
                    if (remainingLetters.includes(inputtedChar.toUpperCase())) {
                        filteredValue += inputtedChar.toUpperCase();
                    }
                }
                input.value = filteredValue;
                lastInputArray[index] = filteredValue;

                UpdateRemainingLetters();
            });
        });
        
        function UpdateRemainingLetters() {
            let inputLetters = ''
            for (let input of inputs) {
                inputLetters += input.value;
            }
            remainingLetters = allLetters;
            for (let letter of inputLetters) {
                remainingLetters = remainingLetters.replace(letter, '');
            }
            if (remainingLetters.length > 0) {
                document.getElementById('remainingLetters').innerText = remainingLetters;
            } else {
                document.getElementById('remainingLetters').innerText = 'æ— ';
            }
        }

        UpdateRemainingLetters();

        const submitButton = document.getElementById('submitButton');
        const startToggleButton = document.getElementById('startToggleButton');
        const shareButton = document.getElementById('shareButton');
        const puzzle = document.getElementById('puzzle');
        const timerDisplay = document.getElementById('timer');
        let hasStarted = false;
        let isPlaying = false;
        let hasCompleted = false;
        let timeElapsed = 0;
        let timer;

        function CheckAnswers() {
            let isComplete = true;
            inputs.forEach((input, index) => {
                let inputValue = input.value;
                let ans = answerArray[index];
                if (inputValue == ans) {
                    input.classList.add('is-valid');
                    input.classList.remove('is-invalid');
                } else {
                    isComplete = false;
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                    errorCountArray[index] += 1;
                }
            });

            if (isComplete) {
                clearInterval(timer);
                startToggleButton.style.display = 'none';
                shareButton.style.display = 'block';
                const additionalInfo = document.getElementById('additionalInfo');
                const completeInfo = document.getElementById('completeInfo');
                const solutionDisplay = document.getElementById('solution');
                additionalInfo.style.display = 'none';
                completeInfo.innerText = 'å·²å®Œæˆè¯¥è°œé¢˜ï¼';
                solutionDisplay.innerHTML = solution;
                hasCompleted = true;
            }
        }

        submitButton.addEventListener('click', () => {
            CheckAnswers();
        });

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }
        
        startToggleButton.addEventListener('click', () => {
            if (isPlaying) {
                clearInterval(timer);
                startToggleButton.innerText = 'æ¢å¤';
                puzzle.style.display = 'none';
            } else {
                timer = setInterval(() => {
                    timeElapsed++;
                    timerDisplay.textContent = formatTime(timeElapsed);
                }, 1000);
                startToggleButton.innerText = 'æš‚åœ';
                puzzle.style.display = 'block';
            }
            isPlaying = !isPlaying;
        })

        function GetChineseCurrentDate() {
            const date = new Date();

            // è·å–å¹´ã€æœˆã€æ—¥
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // æœˆä»½ä»0å¼€å§‹ï¼Œæ‰€ä»¥éœ€è¦åŠ 1
            const day = date.getDate();

            // æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        function CopyTextToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                shareButton.innerText = 'å·²å¤åˆ¶';
            }).catch((error) => {
                console.error('å¤åˆ¶å¤±è´¥:', error);
            });
        }

        shareButton.addEventListener('click', () => {
            let timeUsed = timerDisplay.innerText;
            let totalErrorTime = errorCountArray.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
            let gameStat = '';
            for (let errorCount of errorCountArray) {
                switch (errorCount) {
                    case 0: 
                        gameStat += 'ğŸŸ¢';
                        break;
                    case 1: 
                        gameStat += 'ğŸŸ¡';
                        break;
                    case 2: 
                        gameStat += 'ğŸŸ ';
                        break;
                    default: 
                        gameStat += 'ğŸ”´';
                        break;
                }
            }
            let url = 'https://amwayy.github.io/puzzles/quintagram';
            let shareText = `Cryptic Quintagram - ${GetChineseCurrentDate()}\næˆ‘ç”¨æ—¶${timeUsed}å®Œæˆäº†ä»Šæ—¥è°œé¢˜ï¼Œå…±å¤±è¯¯${totalErrorTime}æ¬¡\n${gameStat}\n${url}`;
            CopyTextToClipboard(shareText);
        });

        shareButton.addEventListener('mouseleave', () => {
            shareButton.innerHTML = '<i class="bi bi-upload me-1" data-bs-placement="left"></i>åˆ†äº«';
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Cryptic Quintagram</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-body-tertiary">
    <div class="container col-10 col-md-6 col-lg-5">
        <div class="mt-5"></div>

        <div class="d-flex justify-content-center fs-3 mb-2"><strong>Cryptic Quintagram</strong></div>
        <div class="d-flex justify-content-center mb-3">给定答案的所有字母，解出5个cryptic clues吧</div>
        <div class="d-flex justify-content-center align-items-center mb-3">
            <span class="me-5" id="timer">00:00</span>
            <button class="btn btn-dark" id="startToggleButton">开始</button>
            <button class="btn btn-dark" id="shareButton" style="display: none;" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="失误数以clue为单位<br>（🟢0🟡1🟠2🔴3+）">
                <i class="bi bi-upload me-1" data-bs-placement="left"></i>
                分享
            </button>
        </div>

        <div id="puzzle" style="display: none;">
            <div class="d-flex justify-content-center mb-3">
                <ul class="list-group border border-dark">
                    <li class="list-group-item">
                        <div class="mb-1" id="clue1"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue2"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue3"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue4"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                    <li class="list-group-item">
                        <div class="mb-1" id="clue5"></div>
                        <input class="form-control focus-ring border border-dark ans-input" style="--bs-focus-ring-color: rgba(var(--bs-dark-rgb), .25);">
                    </li>
                </ul>
            </div>

            <div id="additionalInfo">
                <div class="d-flex justify-content-center"><strong>剩余字母</strong></div>
                <div class="d-flex justify-content-center mb-3" id="remainingLetters"></div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-dark" id="submitButton">提交</button>
                </div>
            </div>
        </div>

        <div id="completeInfo" class="d-flex justify-content-center fs-5 fw-bold mb-2"></div>
        <div id="solution" class="d-flex justify-content-center"></div>

        <!-- <div class="mt-5 d-flex justify-content-center text-secondary">有任何问题？联系管理员：1964825491（QQ）</div> -->
        
        <div class="mb-5"></div>
    </div>

    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        const clueArray = Array('Idiotic plan to get rid of Republican (4)', 
                                'Son needs some trousers (6)',
                                'Reputation of old city featured in Express (7)', 
                                'A mistake making loaf of this kind? (7)',
                                'Date once ruined an amusing tale (8)');
        const answerArray = Array('DAFT', 'SLACKS', 'STATURE', 'BLOOMER', 'ANECDOTE');
        const solution = '1. def: idiotic; plan=draft; Republican=r; get rid of表示去除字母(draft-r) <br>2. def: some trousers; son=s; need=lacks <br>3. def: reputation; old city=ur; express=state; featured in表示包含 <br>4. double definition (mistake/loaf) <br>5. def: amusing tale; "date once" anagram (indicator: ruined) <br>'
        let lengthArray = Array(0, 0, 0, 0, 0);
        let allLetters = '';
        let lastInputArray = Array('', '', '', '', '');
        let remainingLetters = allLetters;
        let errorCountArray = Array(0, 0, 0, 0, 0);
        
        for (let i = 0; i < 5; i++) {
            let ans = answerArray[i];
            allLetters += ans;

            let clueDisplay = document.getElementById(`clue${i + 1}`);
            let clue = clueArray[i];
            clueDisplay.innerHTML = `<strong>${i + 1}</strong> ${clue}`;

            lengthArray[i] = ans.length;
        }
        allLetters = allLetters.split('').sort().join('');
        
        function GetCommonPrefix(str1, str2) {
            let prefix = "";
            const minLength = Math.min(str1.length, str2.length);

            for (let i = 0; i < minLength; i++) {
                if (str1[i] === str2[i]) {
                    prefix += str1[i];
                } else {
                    break;
                }
            }

            return prefix;
        }

        // 限制输入字母集，并转为大写，限制长度
        let inputs = document.querySelectorAll('.ans-input');
        inputs.forEach((input, index) => {
            // 按下回车时跳转到下一个input
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (index + 1 < inputs.length) {
                        inputs[index + 1].focus();
                    }
                }
            });

            input.setAttribute('maxlength', lengthArray[index]);
            input.addEventListener('input', () => {
                // 输入后去除答案验证
                input.classList.remove('is-valid');
                input.classList.remove('is-invalid');

                let lastInput = lastInputArray[index];
                let curInput = input.value;
                let commonPrefix = GetCommonPrefix(lastInput, curInput);
                let filteredValue = commonPrefix;
                for (let i = commonPrefix.length; i < curInput.length; i++) {
                    let inputtedChar = curInput[i];
                    if (remainingLetters.includes(inputtedChar.toUpperCase())) {
                        filteredValue += inputtedChar.toUpperCase();
                    }
                }
                input.value = filteredValue;
                lastInputArray[index] = filteredValue;

                UpdateRemainingLetters();
            });
        });
        
        function UpdateRemainingLetters() {
            let inputLetters = ''
            for (let input of inputs) {
                inputLetters += input.value;
            }
            remainingLetters = allLetters;
            for (let letter of inputLetters) {
                remainingLetters = remainingLetters.replace(letter, '');
            }
            if (remainingLetters.length > 0) {
                document.getElementById('remainingLetters').innerText = remainingLetters;
            } else {
                document.getElementById('remainingLetters').innerText = '无';
            }
        }

        UpdateRemainingLetters();

        const submitButton = document.getElementById('submitButton');
        const startToggleButton = document.getElementById('startToggleButton');
        const shareButton = document.getElementById('shareButton');
        const puzzle = document.getElementById('puzzle');
        const timerDisplay = document.getElementById('timer');
        let hasStarted = false;
        let isPlaying = false;
        let hasCompleted = false;
        let timeElapsed = 0;
        let timer;

        function CheckAnswers() {
            let isComplete = true;
            inputs.forEach((input, index) => {
                let inputValue = input.value;
                let ans = answerArray[index];
                if (inputValue == ans) {
                    input.classList.add('is-valid');
                    input.classList.remove('is-invalid');
                } else {
                    isComplete = false;
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                    errorCountArray[index] += 1;
                }
            });

            if (isComplete) {
                clearInterval(timer);
                startToggleButton.style.display = 'none';
                shareButton.style.display = 'block';
                const additionalInfo = document.getElementById('additionalInfo');
                const completeInfo = document.getElementById('completeInfo');
                const solutionDisplay = document.getElementById('solution');
                additionalInfo.style.display = 'none';
                completeInfo.innerText = '已完成该谜题！';
                solutionDisplay.innerHTML = solution;
                hasCompleted = true;
            }
        }

        submitButton.addEventListener('click', () => {
            CheckAnswers();
        });

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }
        
        startToggleButton.addEventListener('click', () => {
            if (isPlaying) {
                clearInterval(timer);
                startToggleButton.innerText = '恢复';
                puzzle.style.display = 'none';
            } else {
                timer = setInterval(() => {
                    timeElapsed++;
                    timerDisplay.textContent = formatTime(timeElapsed);
                }, 1000);
                startToggleButton.innerText = '暂停';
                puzzle.style.display = 'block';
            }
            isPlaying = !isPlaying;
        })

        function GetChineseCurrentDate() {
            const date = new Date();

            // 获取年、月、日
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // 月份从0开始，所以需要加1
            const day = date.getDate();

            // 格式化日期字符串
            return `${year}年${month}月${day}日`;
        }

        function CopyTextToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                shareButton.innerText = '已复制';
            }).catch((error) => {
                console.error('复制失败:', error);
            });
        }

        shareButton.addEventListener('click', () => {
            let timeUsed = timerDisplay.innerText;
            let totalErrorTime = errorCountArray.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
            let gameStat = '';
            for (let errorCount of errorCountArray) {
                switch (errorCount) {
                    case 0: 
                        gameStat += '🟢';
                        break;
                    case 1: 
                        gameStat += '🟡';
                        break;
                    case 2: 
                        gameStat += '🟠';
                        break;
                    default: 
                        gameStat += '🔴';
                        break;
                }
            }
            let url = 'https://amwayy.github.io/puzzles/quintagram';
            let shareText = `Cryptic Quintagram - ${GetChineseCurrentDate()}\n我用时${timeUsed}完成了今日谜题，共失误${totalErrorTime}次\n${gameStat}\n${url}`;
            CopyTextToClipboard(shareText);
        });

        shareButton.addEventListener('mouseleave', () => {
            shareButton.innerHTML = '<i class="bi bi-upload me-1" data-bs-placement="left"></i>分享';
        });
    </script>
</body>
</html>